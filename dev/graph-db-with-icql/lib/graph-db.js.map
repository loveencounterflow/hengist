{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/graph-db.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n\n\n'use strict'\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'GRAPHDB'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\n{ Dba }                   = require '../../../apps/icql-dba'\ndef                       = Object.defineProperty\ntypes                     = require './types'\n{ SQL, I, L, X, }         = new ( require '../../../apps/icql-dba/lib/sql' ).Sql\njr                        = JSON.stringify\n\n\n#===========================================================================================================\nclass @Graphdb\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( cfg ) ->\n    # super()\n    def @, 'types', enumerable: false, value: types\n    @types.validate.gdb_constructor_cfg ( cfg = { @types.defaults.gdb_constructor_cfg..., cfg..., } )\n    @cfg        = cfg\n    { schema\n      ram\n      path    } = @cfg\n    def @, 'dba', enumerable: false, value: new Dba()\n    dba_cfg     = {}\n    dba_cfg.schema  = schema  if schema?\n    dba_cfg.ram     = ram     if ram?\n    dba_cfg.path    = path    if path?\n    @dba.open dba_cfg\n    @init_db()\n    return undefined\n\n\n  #=========================================================================================================\n  # SCHEMA\n  #---------------------------------------------------------------------------------------------------------\n  init_db: () ->\n    ### TAINT edges are modelled as uniquely given by `( node_id_a, node_id_b )` with arbitrary data\n    attached, but could conceivably link two given nodes with any number of edges ###\n    sql = SQL\"\"\"\n      create table if not exists #{I @cfg.schema}.nodes (\n          body json,\n          id   text generated always as ( json_extract( body, '$.id' ) ) virtual not null unique\n        );\n      -- ...................................................................................................\n      create table if not exists #{I @cfg.schema}.edges (\n          source     text,\n          target     text,\n          properties json,\n        primary key ( source, target )\n        foreign key( source ) references nodes( id ),\n        foreign key( target ) references nodes( id )\n        );\n      -- ...................................................................................................\n      create index if not exists #{I @cfg.schema}.id_idx on nodes(id);\n      create index if not exists #{I @cfg.schema}.source_idx on edges(source);\n      create index if not exists #{I @cfg.schema}.target_idx on edges(target);\"\"\"\n    @dba.execute sql\n    return null\n\n\n  #=========================================================================================================\n  # INSERT, UPDATE, DELETE\n  #---------------------------------------------------------------------------------------------------------\n  delete_edges: ( source = null, target = null ) ->\n    if source is null\n      if target is null then  sql = SQL\"delete from edges;\"\n      else                    sql = SQL\"delete from edges where target is $target;\"\n    else\n      if target is null then  sql = SQL\"delete from edges where source = $source;\"\n      else                    sql = SQL\"delete from edges where source = $source and target = $target;\"\n    return @dba.run sql, { source, target, }\n\n  #=========================================================================================================\n  insert_edge: ( source, target, properties ) ->\n    sql = SQL\"insert into edges ( source, target, properties ) values ( ?, ?, ? )\"\n    return @dba.run sql, [ source, target, ( jr properties ), ]\n\n  #---------------------------------------------------------------------------------------------------------\n  upsert_edge: ( source, target, properties ) ->\n    @types.validate.gdb_edge_properties properties\n    sql = SQL\"\"\"\n      insert into edges ( source, target, properties )\n        values ( $source, $target, $properties )\n        on conflict ( source, target ) do update set properties = $properties;\"\"\"\n    return @dba.run sql, { source, target, properties: ( jr properties ), }\n\n  #---------------------------------------------------------------------------------------------------------\n  upmerge_edge: ( source, target, properties ) ->\n    @types.validate.gdb_edge_properties properties\n    sql = SQL\"\"\"\n      insert into edges as e ( source, target, properties )\n        values ( $source, $target, $properties )\n        on conflict ( source, target ) do update set properties = json_patch( e.properties, $properties );\"\"\"\n    return @dba.run sql, { source, target, properties: ( jr properties ), }\n\n  #---------------------------------------------------------------------------------------------------------\n  update_edge: ( source, target, properties ) ->\n    @types.validate.gdb_edge_properties properties\n    sql = SQL\"update edges set properties = json( $properties ) where source = $source and target = $target;\"\n    return @dba.run sql, { source, target, properties: ( jr properties ), }\n\n  #=========================================================================================================\n  insert_node: ( body ) ->\n    @types.validate.gdb_node_body body\n    sql = SQL\"insert into nodes ( body ) values ( ? )\"\n    return @dba.run sql, [ ( jr body ), ]\n\n  #---------------------------------------------------------------------------------------------------------\n  upsert_node: ( body ) ->\n    ### Inserts or updates a node with a given `body`, replacing all existing atrs. ###\n    @types.validate.gdb_node_body body\n    sql = SQL\"\"\"\n      insert into nodes ( body )\n        values ( $body )\n        on conflict ( id ) do update set body = $body;\"\"\"\n    return @dba.run sql, { body: jr body, }\n\n  #---------------------------------------------------------------------------------------------------------\n  upmerge_node: ( body ) ->\n    ### Inserts or merges a node with a given `body`, using [SQLite `json_patch()`\n    function](https://www.sqlite.org/json1.html#jpatch) which is an implementation of [the RFC-7396\n    MergePatch algorithm](https://tools.ietf.org/html/rfc7396). ###\n    @types.validate.gdb_node_body body\n    sql = SQL\"\"\"\n      insert into nodes as n ( body )\n        values ( $body )\n        on conflict ( id ) do update set body = json_patch( n.body, $body );\"\"\"\n    return @dba.run sql, { body: jr body, }\n\n  #---------------------------------------------------------------------------------------------------------\n  update_node: ( body ) ->\n    sql = SQL\"update nodes set body = json( $body ) where id = $id;\"\n    return @dba.run sql, { body: ( jr body ), id: body.id, }\n\n  #---------------------------------------------------------------------------------------------------------\n  delete_node: ( id ) ->\n    sql = SQL\"delete from nodes where id = $id\"\n\n  #=========================================================================================================\n  search_edges_inbound: () ->\n    sql = SQL\"select * from edges where source = ?\"\n\n  #---------------------------------------------------------------------------------------------------------\n  search_edges_outbound: () ->\n    sql = SQL\"select * from edges where target = ?\"\n\n\n  #=========================================================================================================\n  # SEARCH\n  #---------------------------------------------------------------------------------------------------------\n  search_edges: () ->\n    sql = SQL\"\"\"\n      select * from edges where source = ?\n      union\n      select * from edges where target = ?\"\"\"\n\n  #---------------------------------------------------------------------------------------------------------\n  search_node_by_id: () ->\n    ### TAINT instead of 'json_extract(body, '$.id')', use virtual field(?) ###\n    sql = SQL\"select body from nodes where json_extract(body, '$.id') = ?\"\n\n  #---------------------------------------------------------------------------------------------------------\n  search_node: () ->\n    sql = SQL\"select body from nodes where\"\n\n\n  #=========================================================================================================\n  # TRAVERSE\n  #---------------------------------------------------------------------------------------------------------\n  traverse_inbound: () ->\n    sql = SQL\"\"\"\n      with recursive traverse(id) as (\n        select ?\n        union\n        select source from edges join traverse on target = id\n      ) select id from traverse;\"\"\"\n\n  #---------------------------------------------------------------------------------------------------------\n  traverse_outbound: () ->\n    sql = SQL\"\"\"\n      with recursive traverse(id) as (\n        select ?\n        union\n        select target from edges join traverse on source = id\n      ) select id from traverse;\"\"\"\n\n  #---------------------------------------------------------------------------------------------------------\n  traverse: () ->\n    sql = SQL\"\"\"\n      with recursive traverse(id) as (\n        select ?\n        union\n        select source from edges join traverse on target = id\n        union\n        select target from edges join traverse on source = id\n      ) select id from traverse;\"\"\"\n\n  #---------------------------------------------------------------------------------------------------------\n  traverse_with_bodies_inbound: () ->\n      sql = SQL\"\"\"\n      with recursive traverse(x, y, obj) as (\n        select ?, ?, ?\n        union\n        select id, '()', body from nodes join traverse on id = x\n        union\n        select source, '<-', properties from edges join traverse on target = x\n      ) select x, y, obj from traverse;\"\"\"\n\n  #---------------------------------------------------------------------------------------------------------\n  traverse_with_bodies_outbound: () ->\n    sql = SQL\"\"\"\n      with recursive traverse(x, y, obj) as (\n        select ?, ?, ?\n        union\n        select id, '()', body from nodes join traverse on id = x\n        union\n        select target, '->', properties from edges join traverse on source = x\n      ) select x, y, obj from traverse;\"\"\"\n\n  #---------------------------------------------------------------------------------------------------------\n  traverse_with_bodies: () ->\n    sql = SQL\"\"\"\n      with recursive traverse(x, y, obj) as (\n        select ?, ?, ?\n        union\n        select id, '()', body from nodes join traverse on id = x\n        union\n        select source, '<-', properties from edges join traverse on target = x\n        union\n        select target, '->', properties from edges join traverse on source = x\n      ) select x, y, obj from traverse;\"\"\"\n\n\n"
  ]
}