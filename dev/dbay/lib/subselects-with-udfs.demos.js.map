{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/subselects-with-udfs.demos.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n'use strict'\n\n###\n\nVariables:\n\n* (2) **`use_unsafe: [ true, false, ]`**: safe mode on / off\n* (2) **`use_transaction: [ true, false, ]`**: explicit vs implicit transaction\n* (2) **`single_connection: [ true, false, ]`**: single connection vs double connection\n* (2) **`use_worker: [ true, false, ]`**: single thread vs main thread + worker thread\n* (2) **`use_subselect_function: [ true, false, ]`**: using a function that does no sub-select vs function\n  that does\n* (4) **`function_type: [ 'none', 'scalar', 'table', 'sqlite', ]`**: SQL using no UDF, using scalar UDF,\n  using table UDF, using SQLite function[^1]\n* (2) **`use_nested_statement: [ true, false, ]`**: use nested statement or not\n\n2^6 * 4^1 = 64 * 4 = 256 possible variants (but minus some impossible combinations)\n\nchanges:\n\n* (?) **`transaction_type: [ 'deferred', ..., ]`**\n* (?) **`journalling_mode: [ 'wal', 'memory', ..., ]`**\n\nNotes:\n\n[^1]: using a function provided by SQLite will not lead to equivalent results because there's no SQLite\n  function that provides a sub-select.\n\n###\n\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'DBAY/DEMOS/UDFSEL'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\n#...........................................................................................................\nPATH                      = require 'path'\nH                         = require './helpers'\ntypes                     = new ( require 'intertype' ).Intertype\n{ equals\n  isa\n  type_of\n  validate\n  validate_list_of }      = types.export()\nSQL                       = String.raw\nguy                       = require '../../../apps/guy'\n#-----------------------------------------------------------------------------------------------------------\ncfg =\n  # verbose:              true\n  verbose:              false\n  catch_errors:         false\n  show_skipped_choices: true\n  # show_skipped_choices: false\n  choices:\n    uu: [ true, false, ]                                            ### use_unsafe            ###\n    sc: [ true, false, ]                                            ### single_connection     ###\n    ut: [ true, false, ]                                            ### use_transaction       ###\n    uw: [ null, ]        # [ true, false, ]                         ### use_worker            ###\n    sf: [ null, ]        # [ true, false, ]                         ### sf                    ###\n    # ft: [ null, ]        # [ 'none', 'scalar', 'table', 'sqlite', ] ### function_type         ###\n    ft: [ 'none', 'scalar', 'table', ]                              ### function_type         ###\n    un: [ true, false, ]                                            ### use_nested_statement  ###\n  results:\n    not_applicable:   Symbol 'not_applicable'\n    not_implemented:  Symbol 'not_implemented'\n\n#-----------------------------------------------------------------------------------------------------------\nprepare_db = ( db ) ->\n  db.sqlt1.exec SQL\"create table x ( word text, nrx );\"\n  db.sqlt1.exec SQL\"create table y ( word text, nry );\"\n  for word, idx in \"foo bar baz\".split /\\s+/\n    nrx = idx + 1\n    ( db.sqlt1.prepare SQL\"insert into x ( word, nrx ) values ( $word, $nrx );\" ).run { word, nrx, }\n    for n in [ 1, 2, 3, ]\n      nry = nrx + n * 2\n      ( db.sqlt1.prepare SQL\"insert into y ( word, nry ) values ( $word, $nry );\" ).run { word, nry, }\n  fn_cfg = { deterministic: false, varargs: false, }\n  ### TAINT use other connection for query ###\n  for connection in [ db.sqlt1, db.sqlt2, ]\n    connection.function 'join_x_and_y_using_word_scalar', fn_cfg, ->\n      return JSON.stringify join_x_and_y_using_word connection\n    # connection.table 'join_x_and_y_using_word_table', fn_cfg, ->\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\njoin_x_and_y_using_word = ( sqlt ) ->\n  statement = sqlt.prepare SQL\"\"\"\n    select\n        x.word  as word,\n        x.nrx   as nrx,\n        y.nry   as nry\n      from x\n      join y on ( x.word = y.word )\n      order by 1, 2, 3;\"\"\"\n  return statement.all()\n\n#-----------------------------------------------------------------------------------------------------------\nget_matcher = ( db ) -> join_x_and_y_using_word db.sqlt1\n\n#-----------------------------------------------------------------------------------------------------------\nget_kenning = ( fingerprint ) ->\n  R = []\n  for k, v of fingerprint\n    v = if v is true then '1' else ( if v is false then '0' else rpr v )\n    R.push \"#{k}:#{v}\"\n  return R.join ','\n\n#-----------------------------------------------------------------------------------------------------------\n_begin_transaction = ( ut, sqlt_a, sqlt_b ) ->\n  return unless ut\n  debug '^334-1^', \"begin tx\" if cfg.verbose\n  sqlt_a.exec SQL\"begin transaction;\"\n  sqlt_b.exec SQL\"begin transaction;\" if sqlt_a isnt sqlt_b\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n_commit_transaction = ( ut, sqlt_a, sqlt_b ) ->\n  return unless ut\n  debug '^334-2^', \"commit tx\" if cfg.verbose\n  sqlt_a.exec SQL\"commit;\"\n  sqlt_b.exec SQL\"commit;\" if sqlt_a isnt sqlt_b\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\nquery_with_nested_statement = ( db, fingerprint, sqlt_a, sqlt_b ) ->\n  switch fingerprint.ft\n    #.......................................................................................................\n    when 'none'\n      ### TAINT refactor ###\n      result = []\n      outer_statement = sqlt_a.prepare SQL\"select * from x order by 1, 2;\"\n      for outer_row from outer_statement.iterate()\n        inner_statement = sqlt_b.prepare SQL\"select * from y where word = $word order by 1, 2;\"\n        for inner_row in inner_rows = inner_statement.all { word: outer_row.word, }\n          result.push { word: outer_row.word, nrx: outer_row.nrx, nry: inner_row.nry, }\n      return { result, }\n    #.......................................................................................................\n    # when 'scalar'\n    #   ### TAINT refactor ###\n    #   result = []\n    #   outer_statement = sqlt_a.prepare SQL\"select * from x order by 1, 2;\"\n    #   for outer_row from outer_statement.iterate()\n    #     inner_statement = sqlt_b.prepare SQL\"select * from y where word = $word order by 1, 2;\"\n    #     for inner_row in inner_rows = inner_statement.all { word: outer_row.word, }\n    #       result.push { word: outer_row.word, nrx: outer_row.nrx, nry: inner_row.nry, }\n    #   return { result, }\n  return { result: cfg.results.not_implemented, error: \"ft: #{rpr fingerprint.ft} not implemented\", }\n\n#-----------------------------------------------------------------------------------------------------------\nquery_without_nested_statement = ( db, fingerprint, sqlt_a, sqlt_b ) ->\n  switch fingerprint.ft\n    when 'none'\n      return { result: ( join_x_and_y_using_word sqlt_a ), }\n    when 'scalar'\n      statement = sqlt_a.prepare SQL\"\"\"\n        select join_x_and_y_using_word_scalar() as rows;\"\"\"\n      result = statement.get()\n      result = JSON.parse result.rows\n      return { result, }\n  return { result: cfg.results.not_implemented, error: \"ft: #{rpr fingerprint.ft} not implemented\", }\n\n#-----------------------------------------------------------------------------------------------------------\nff = ( db, fingerprint ) ->\n  sqlt_a        = db.sqlt1\n  sqlt_b        = db.sqlt2\n  error         = null\n  result        = null\n  { uu, sc, ut,\n    uw, sf, ft,\n    un, }       = fingerprint\n  #.........................................................................................................\n  if uu\n    db.sqlt1.unsafeMode true\n    db.sqlt2.unsafeMode true\n  #.........................................................................................................\n  if sc\n    sqlt_b = db.sqlt1\n  #.........................................................................................................\n  try\n    if ut\n      unless un then return { result: cfg.results.not_applicable, error: \"need nested stms for tx:1\", } if ut\n      unless sc then return { result: cfg.results.not_applicable, error: \"need single conn for tx:1\", } if ut\n    _begin_transaction ut, sqlt_a, sqlt_b\n    #.......................................................................................................\n    if un ### use_nested_statement ###\n      R = query_with_nested_statement db, fingerprint, sqlt_a, sqlt_b\n    else ### do not use_nested_statement ###\n      R = query_without_nested_statement db, fingerprint, sqlt_a, sqlt_b\n    #.......................................................................................................\n    _commit_transaction ut, sqlt_a, sqlt_b\n    return R\n  #.........................................................................................................\n  catch error\n    throw error unless cfg.catch_errors\n    error = \"(#{error.message})\"\n    return { error, }\n  #.........................................................................................................\n  finally\n    if uu\n      db.sqlt1.unsafeMode false\n      db.sqlt2.unsafeMode false\n    #.......................................................................................................\n    if sc\n      sqlt_b = db.sqlt2\n  #.........................................................................................................\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\ndemo_f = ->\n  { Dbay }  = require H.dbay_path\n  db        = new Dbay()\n  prepare_db db\n  matcher   = get_matcher db\n  counts    =\n    total:            0\n    not_implemented:  0\n    not_applicable:   0\n    other:            0\n    error:            0\n    test:             0\n    success:          0\n    fail:             0\n  #.........................................................................................................\n  for             uu in cfg.choices.uu  ### use_unsafe            ###\n    for           sc in cfg.choices.sc  ### single_connection     ###\n      for         ut in cfg.choices.ut  ### use_transaction       ###\n        for       uw in cfg.choices.uw  ### use_worker            ###\n          for     sf in cfg.choices.sf  ### sf                    ###\n            for   ft in cfg.choices.ft  ### function_type         ###\n              for un in cfg.choices.un  ### use_nested_statement  ###\n                counts.total++\n                fingerprint   = { uu, sc, ut, uw, sf, ft, un, }\n                kenning       = get_kenning fingerprint\n                { result\n                  error }     = ff db, fingerprint\n                # debug '^3453^', result, isa.symbol result\n                if ( isa.symbol result )\n                  switch result\n                    when cfg.results.not_implemented\n                      counts.not_implemented++\n                      color = CND.red\n                    when cfg.results.not_applicable\n                      counts.not_applicable++\n                      color = CND.grey\n                    else\n                      counts.other++\n                      color = CND.yellow\n                  if cfg.show_skipped_choices\n                    whisper '^450^', 0, color kenning, result, error\n                  continue\n                counts.test++\n                if ( is_ok = equals result, matcher ) then  counts.success++\n                else                                        counts.fail++\n                if error?                             then  counts.error++\n                info '^450^', ( CND.blue counts.test, kenning ), ( CND.truth is_ok ), ( CND.red error ? '' )\n                warn '^338^', result unless is_ok\n  #.........................................................................................................\n  for k, v of counts\n    help ( k.padStart 20 ), ( v.toString().padStart 5 )\n  return null\n\n\n############################################################################################################\nif require.main is module then do =>\n  await demo_f()\n\n"
  ]
}