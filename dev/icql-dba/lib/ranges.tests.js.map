{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/ranges.tests.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n'use strict'\n\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'ICQL-DBA/TESTS/BASICS'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\n#...........................................................................................................\ntest                      = require '../../../apps/guy-test'\nPATH                      = require 'path'\nH                         = require './helpers'\ntypes                     = new ( require 'intertype' ).Intertype\n{ isa\n  type_of\n  validate\n  validate_list_of }      = types.export()\n# { to_width }              = require 'to-width'\non_process_exit           = require 'exit-hook'\nsleep                     = ( dts ) -> new Promise ( done ) => setTimeout done, dts * 1000\nSQL                       = String.raw\njr                        = JSON.stringify\njp                        = JSON.parse\ndba_path                  = '../../../apps/icql-dba'\n{ lets\n  freeze }                = require 'letsfreezethat'\n\n\n#===========================================================================================================\ntypes.declare 'tags_constructor_cfg', tests:\n  '@isa.object x':        ( x ) -> @isa.object x\n  'x.prefix is a prefix': ( x ) ->\n    return false unless @isa.text x.prefix\n    return true if x.prefix is ''\n    return ( /^[_a-z][_a-z0-9]*$/ ).test x.prefix\n\n#-----------------------------------------------------------------------------------------------------------\ntypes.defaults =\n  tags_constructor_cfg:\n    dba:        null\n    prefix:     't_'\n\n\n#===========================================================================================================\nclass Dbatags\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( cfg ) ->\n    validate.tags_constructor_cfg @cfg = { types.defaults.tags_constructor_cfg..., cfg..., }\n    if @cfg.dba?\n      @dba  = @cfg.dba\n      delete @cfg.dba\n    else\n      @dba  = new ( require dba_path ).Dba()\n    @cfg = freeze @cfg\n    @_create_db_structure()\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  _create_db_structure: ->\n    x = @cfg.prefix\n    @dba.execute SQL\"\"\"\n      create table if not exists #{x}tags ( tag text unique not null primary key );\n      create table if not exists #{x}tagged_cid_ranges (\n          nr      integer not null primary key,\n          cid_lo  integer not null,\n          cid_hi  integer not null,\n          -- chr_lo  text generated always as ( chr_from_cid( cid_lo ) ) virtual not null,\n          -- chr_hi  text generated always as ( chr_from_cid( cid_hi ) ) virtual not null,\n          tag     text    not null references #{x}tags ( tag ) );\n      create index if not exists #{x}cidlohi_idx on #{x}tagged_cid_ranges ( cid_lo, cid_hi );\n      create index if not exists #{x}cidhi_idx on   #{x}tagged_cid_ranges ( cid_hi );\n      create table if not exists #{x}tagged_cids (\n          cid     integer not null,\n          -- chr     text    not null,\n          tag     text    not null,\n          value   json    not null,\n        primary key ( cid, tag ) );\n      \"\"\"\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  tag_pattern: ///\n    ^\n    (?<mode>  [ - + ] )\n    (?<key>   [ a-z A-Z _ \\/ \\$ ] [ - a-z A-Z 0-9 _ \\/ \\$ ]* )\n    ( : (?<value> [^ - + ]+ | ' .* ' | \" .* \" ) )?\n    $\n    ///\n\n  #---------------------------------------------------------------------------------------------------------\n  tags_from_tagchain: ( tagchain ) ->\n    validate_list_of.text tagchain\n    R = {}\n    return R if tagchain.length is 0\n    for tag_expression in tagchain\n      unless ( match = tag_expression.match @tag_pattern )?\n        throw new Error \"^tags_from_tagchain@448^ tag expression not recognized: #{rpr tag_expression}\"\n      # debug '^9458^', match\n      { mode, key, value, }   = match.groups\n      switch mode\n        when '+'\n          unless value?                       then value = true\n          else if value[ 0 ] in [ '\"', \"'\", ] then value = value[ 1 ... value.length - 1 ]\n          R[ key ] = value\n        when '-'\n          delete R[ key ]\n    return R\n\n\n#===========================================================================================================\nclass Ncr\n  # constructor: ->\n  #---------------------------------------------------------------------------------------------------------\n  parse_multirange_declaration: ( range_declaration ) ->\n    validate.text range_declaration\n    R = []\n    return R if range_declaration is ''\n    for part in range_declaration.split /,\\s+/\n      if ( match = part.match /^(?<lo>.+)\\.\\.(?<hi>.+)/ )?\n        lo  = match.groups.lo.codePointAt 0\n        hi  = match.groups.hi.codePointAt 0\n      else\n        validate.chr part\n        lo = hi = part.codePointAt 0\n      R.push { lo, hi, }\n    return R\nNCR = new Ncr()\n\n\n############################################################################################################\n@[ \"tags: tags_from_tagchain\" ] = ( T, done ) ->\n  T?.halt_on_error()\n  #.........................................................................................................\n  probes_and_matchers = [\n    [ [ '+foo',                             ],  { foo: true,          }, ]\n    [ [ '+foo:abc',                         ],  { foo: 'abc',         }, ]\n    [ [ '+font:superset',                   ],  { font: 'superset',   }, ]\n    [ [ '+font:font1',                      ],  { font: 'font1',      }, ]\n    [ [ '+font:\"font1\"',                    ],  { font: 'font1',      }, ]\n    [ [ \"+font:'font1'\",                    ],  { font: 'font1',      }, ]\n    [ [ '+font:font1',  '+font:Arial'       ],  { font: 'Arial',      }, ]\n    [ [ '+rounded', '-rounded',             ],  {},                      ]\n    [ [ '+shape/ladder', '+shape/pointy',   ],  { 'shape/ladder': true, 'shape/pointy': true, },                      ]\n    ]\n  dbatags = new Dbatags()\n  for [ probe, matcher, error, ] in probes_and_matchers\n    await T.perform probe, matcher, error, -> new Promise ( resolve ) ->\n      result = dbatags.tags_from_tagchain probe\n      resolve result\n  #.........................................................................................................\n  done?()\n\n#-----------------------------------------------------------------------------------------------------------\n@[ \"DBA: ranges (1)\" ] = ( T, done ) ->\n  T?.halt_on_error()\n  { Dba }           = require '../../../apps/icql-dba'\n  E                 = require '../../../apps/icql-dba/lib/errors'\n  prefix            = 't_'\n  dba               = new Dba()\n  dbatags           = new Dbatags { dba, prefix, }\n  cid_from_chr      = ( chr ) -> chr.codePointAt 0\n  chr_from_cid      = ( cid ) -> String.fromCodePoint cid\n  dba.create_function name: 'chr_from_cid', call: chr_from_cid\n  first_cid         = cid_from_chr 'A'\n  last_cid          = cid_from_chr 'Z'\n  #.........................................................................................................\n  dba.create_table_function\n    name:         'generate_series'\n    columns:      [ 'n', ]\n    parameters:   [ 'start', 'stop', 'step', ]\n    rows: ( start, stop, step = null ) ->\n      step ?= 1\n      n     = start\n      loop\n        break if n > stop\n        yield [ n, ]\n        n += step\n      return null\n  # #.........................................................................................................\n  # dba.execute SQL\"\"\"\n  #   create view tags_by_id as\n  #     with\n  #     v1 as ( select min( cid_lo ) as first_cid from tagged_cid_ranges ),\n  #     v2 as ( select max( cid_hi ) as last_cid  from tagged_cid_ranges )\n  #     select\n  #       r1.n                      as cid,\n  #       chr_from_cid( r1.n )      as chr,\n  #       r2.nr                     as nr,\n  #       r2.cid_lo                 as cid_lo,\n  #       r2.cid_hi                 as cid_hi,\n  #       -- r2.chr_lo                 as chr_lo,\n  #       -- r2.chr_hi                 as chr_hi,\n  #       r2.tag                    as tag\n  #     from\n  #       v1,\n  #       v2,\n  #       generate_series( v1.first_cid, v2.last_cid ) as r1\n  #       left join tagged_cid_ranges as r2 on ( r1.n between r2.cid_lo and r2.cid_hi )\n  #     order by r1.n, r2.nr\n  #     ;\n  #   \"\"\"\n  #.........................................................................................................\n  tags_from_cid = ( cid ) ->\n    R   = []\n    sql = SQL\"\"\"\n      select\n          tag\n        from #{prefix}tagged_cid_ranges\n        where $cid between cid_lo and cid_hi\n        order by nr asc;\"\"\"\n    R.push row.tag for row from dba.query sql, { cid, }\n    return R\n  dba.create_function name: \"#{prefix}tags_from_cid\", call: tags_from_cid\n  #.........................................................................................................\n  insert_tag = SQL\"\"\"\n    insert into #{prefix}tags ( tag )\n      values ( $tag )\n      on conflict ( tag ) do nothing;\"\"\"\n  insert_range = SQL\"\"\"\n    insert into #{prefix}tagged_cid_ranges ( nr, cid_lo, cid_hi, tag )\n      values ( $nr, $cid_lo, $cid_hi, $tag )\"\"\"\n  rules = [\n    # [ '+superset',      'A..Z',               ]\n    [ '+font:fallback', 'A..Z',               ]\n    # [ '+script:latin',  'A..Z',               ]\n    [ '+font:font1',    'B..H, J, L, N..X',   ]\n    [ '+font:font2',    'B..D',               ]\n    [ '+font:font3',    'G..I',               ]\n    [ '+font:font4',    'M..Q',               ]\n    [ '+font:font5',    'M, O..T',            ]\n    [ '+font:font6',    'M, U, X..Y',         ]\n    [ '+vowel',         'A, E, I, O, U',      ]\n    [ '+shape/pointy',  'A, V',               ]\n    [ '+shape/crossed', 'X',                  ]\n    [ '+shape/ladder',  'A, H',               ]\n    ]\n  nr = 0\n  for [ tag, ranges, ] in rules\n    dba.run insert_tag, { tag, }\n    for { lo: cid_lo, hi: cid_hi, } in NCR.parse_multirange_declaration ranges\n      nr++\n      dba.run insert_range, { nr, tag, cid_lo, cid_hi, }\n  #.........................................................................................................\n  console.table dba.list dba.query SQL\"\"\"\n    select\n        nr                      as nr,\n        tag                     as tag,\n        chr_from_cid( cid_lo )  as chr_lo,\n        chr_from_cid( cid_hi )  as chr_hi\n      from #{prefix}tagged_cid_ranges\n      order by nr;\"\"\"\n  console.table dba.list dba.query SQL\"\"\"select * from #{prefix}tags order by tag;\"\"\"\n  # console.table dba.list dba.query SQL\"\"\"select * from #{prefix}tags_by_id order by tag, cid, nr;\"\"\"\n  #.........................................................................................................\n  for cid in [ first_cid .. last_cid ]\n    chr       = String.fromCodePoint cid\n    tags      = dbatags.tags_from_tagchain tags_from_cid cid\n    info ( CND.gold chr ), ( CND.blue tags )\n    for tag, value of tags\n      value = JSON.stringify value\n      dba.run SQL\"\"\"\n        insert into #{prefix}tagged_cids ( cid, tag, value )\n          values ( $cid, $tag, $value );\"\"\", { cid, tag, value, }\n  console.table dba.list dba.query SQL\"\"\"select * from #{prefix}tagged_cids order by cid, tag;\"\"\"\n  done?() #..................................................................................................\n\n\n\n############################################################################################################\nif module is require.main then do =>\n  # test @, { timeout: 10e3, }\n  # test @[ \"DBA: ranges (1)\" ]\n  # test @[ \"tags: tags_from_tagchain\" ]\n  @[ \"DBA: ranges (1)\" ]()\n\n\n\n\n###\n# from https://github.com/loveencounterflow/hengist/tree/master/dev/kitty-font-config-writer-kfcw\n\nsuperset          ABCDEFGHIJKLMNOPQRSTUVWXYZ  │ CSS-like Configuration with Overlapping Ranges\n————————————————— ——————————————————————————  ——————————————————————————————————————————————————————————————\nfont1             BCDEFGH J L NOPQRSTUVWX    │ [B-H] [J] [L] [N-X]                      ◮ least precedence\nfont2             BCD                        │ [B-D]                                    │\nfont3                  GHI                   │ [G-I]                                    │\nfont4                        MNOPQ           │ [M-Q]                                    │\nfont5                        M OPQRST        │ [M] [O-T]                                │\nfont6                        M       U  XY   │ [M] [U] [X-Y]                            │ most precedence\n###\n\n\n\n\n"
  ]
}